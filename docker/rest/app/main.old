
import sys
import os
import subprocess

from flask import Flask, jsonify, request, make_response, render_template, redirect, url_for

from paste.request import parse_formvars

def shell_exec(params, capture = False):
    prev_dir = os.getcwd()
    sys.stdout.flush()
    # params.insert(0, "sudo")
    print " ".join(params)
    if capture:
        proc = subprocess.Popen(params, stderr=subprocess.PIPE, stdout=subprocess.PIPE)
        retval, err = proc.communicate()
        # print(retval)
        # print(err)
    else:
        retval = subprocess.call(params)
        os.chdir(prev_dir)
    return retval


def app(environ, start_response):

    if not os.path.isdir('gitolite-admin'):
        shell_exec([
            "git",
            "clone",
            "gitolite@git:gitolite-admin"
        ])

    fields = parse_formvars(environ)

    if environ['REQUEST_METHOD'] == 'POST':
        start_response('200 OK', [('content-type', 'text/html')])
        return ['Hello, ', fields['name'], '!']
    else:
        start_response('200 OK', [('content-type', 'text/html')])
        return ['<form method="POST">Name: <input type="text" '
                'name="name"><input type="submit"></form>']

    #return [json.dumps({'path': environ.get('PATH_INFO', '')})]
